# Maintainer: valr <valere dot monseur at ymail dot com>

pkgname=busybox
pkgver=1.22.1
pkgrel=4
pkgdesc='utilities for rescue and embedded systems'
url='http://www.busybox.net/'
license=('GPL')
groups=('initsystem')
arch=('x86_64')
makedepends=('musl-cross-compiler-x86_64' 'musl')
source=("http://www.busybox.net/downloads/${pkgname}-${pkgver}.tar.bz2"
        http://busybox.net/downloads/fixes-${pkgver}/busybox-$pkgver-{ash,date,iplink,lzop,nc,zcat-no-ext}.patch
        'config_nosuid'
        'config_suid')
md5sums=('337d1a15ab1cb1d4ed423168b1eb7d7e'
         '538d8cddbdfc449239b25a40bc8d1575'
         'bc381f9ceb3824141c968f5bc4353943'
         '24686ec2750a8703feb57fc9c6aaed1d'
         '14fb3bf7ffaba153b3cad385677b18c3'
         '69eecaae5f812d08655dfdf34b60503f'
         '158c8c4c73db6d920bdd7d4b9b65b2a5'
         'f0ec6f16030f84ec8f179c226cab9ccb'
         '818cd3efba9954cf33a9f8563e94e6d4')

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  for PATCH in "${srcdir}"/*.patch; do
    patch -p1 <${PATCH}
  done

  sed -i '1,1i#include <sys/resource.h>' include/libbb.h

  # nosuid

  cp -r "${srcdir}/${pkgname}-${pkgver}" "${srcdir}"/nosuid
  cp "${srcdir}"/config_nosuid "${srcdir}"/nosuid/.config

  # patch to avoid redefinition of structure with musl
  sed -i 's|# include <net/ethernet.h>||' "${srcdir}"/nosuid/networking/ifplugd.c

  # with linux-api-headers 3.18, there is a redefinition of structure with musl
  # that can be solved by commenting out: #include <linux/in6.h> in the header
  # file /usr/include/linux/if_bridge.h

  # suid

  cp -r "${srcdir}/${pkgname}-${pkgver}" "${srcdir}"/suid
  cp "${srcdir}"/config_suid "${srcdir}"/suid/.config
}

build() {
  cd "${srcdir}"/nosuid
  make V=1 CC=/opt/x86_64-linux-musl/bin/x86_64-linux-musl-gcc \
    CFLAGS='-static -D_GNU_SOURCE -Wl,-z,muldefs'

  cd "${srcdir}"/suid
  make V=1 CC=/opt/x86_64-linux-musl/bin/x86_64-linux-musl-gcc \
    CFLAGS='-static -D_GNU_SOURCE -Wl,-z,muldefs'
}

package() {
  # setuid applets:
  # applets that have 'BB_SUID_REQUIRE' in include/applets.src.h
  # crontab, login, passwd, su ,vlock ,wall

  # binaries

  cd "${srcdir}"/nosuid
  install -Dm755 busybox "${pkgdir}"/usr/bin/busybox

  cd "${srcdir}"/suid
  install -Dm4755 busybox "${pkgdir}"/usr/bin/busybox-suid

  # symlinks: install some applets in /usr/bin

  cd "${pkgdir}"/usr/bin
  ln -s /usr/bin/busybox ash

  # symlinks: install (almost) all applets in /opt/busybox

  install -d "${pkgdir}"/opt/busybox
  cd "${pkgdir}"/opt/busybox

  for APPLET in `"${pkgdir}"/usr/bin/busybox --list`; do
    case "${APPLET}" in
      halt|poweroff|reboot)
        ;;
      *)
        ln -s /usr/bin/busybox "${APPLET}"
        ;;
    esac
  done

  for APPLET in `"${pkgdir}"/usr/bin/busybox-suid --list`; do
    ln -s /usr/bin/busybox-suid "${APPLET}"
  done

  install -Dm644 "${srcdir}"/nosuid/README "${pkgdir}"/usr/share/doc/"${pkgname}"/README
  install -Dm644 "${srcdir}"/nosuid/LICENSE "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE
}
