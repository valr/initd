# Maintainer: valr <valere dot monseur at ymail dot com>

pkgname=initsystem
pkgver=1.0.0
pkgrel=50
pkgdesc='An init system'
url='https://github.com/valr/initsystem'
license=('GPL')
groups=('initsystem')
arch=('x86_64')
depends=('busybox' 'musl-cross-x86_64' 'musl-libc' 'systemd' 'kbd')
source=('init.c'
        'rc'
        'rc.respawn'
        'rc.shutdown'
        'tmpfiles'
        'shutdown'
        'LICENSE')
md5sums=('79d5372e15f1239b2d7c32016b4cef91'
         'd0818e65e9adf8722a924a4c7fee78a6'
         '55d7c09f35ce8daa96668599a8ec60f2'
         '49ca68f1e9f4bdf6cff04164741d64b5'
         '6e7860e985e466d9a081464c2524e313'
         'c6f7bdb2aa70c3040849a88a62bcaafa'
         '4641e94ec96f98fabc56ff9cc48be14b')

build() {
  cd "${srcdir}"

  /opt/cross/musl/x86_64-linux-musl/bin/x86_64-linux-musl-gcc -Wall -static -o init init.c
}

package() {

  # binaries

  install -Dm755 "${srcdir}"/init        "${pkgdir}"/sbin/init
  install -Dm755 "${srcdir}"/rc          "${pkgdir}"/etc/rc
  install -Dm755 "${srcdir}"/rc.respawn  "${pkgdir}"/etc/rc.respawn
  install -Dm755 "${srcdir}"/rc.shutdown "${pkgdir}"/etc/rc.shutdown
  install -Dm755 "${srcdir}"/tmpfiles    "${pkgdir}"/usr/bin/tmpfiles
  install -Dm755 "${srcdir}"/shutdown    "${pkgdir}"/usr/bin/shutdown

  # symlinks

  cd "${pkgdir}"/usr/bin

  ln -s shutdown halt
  ln -s shutdown poweroff
  ln -s shutdown reboot

  # services

#todo:
#  install -Dm755 "${srcdir}"/etc-initd-service-udev-rc.main "${pkgdir}"/etc/initd/service/udev/rc.main
#  chmod +t "${pkgdir}"/etc/initd/service/udev
#  touch "${pkgdir}"/etc/initd/service/udev/flag.down

#  install -Dm755 "${srcdir}"/opt-s6-service-svscan-crash   "${pkgdir}"/opt/s6/service/svscan/crash
#  install -Dm755 "${srcdir}"/opt-s6-service-svscan-finish  "${pkgdir}"/opt/s6/service/svscan/finish
#  install -Dm755 "${srcdir}"/opt-s6-service-svscan-log-run "${pkgdir}"/opt/s6/service/svscan-log/run
#  install -Dm755 "${srcdir}"/opt-s6-service-getty-tty1-run "${pkgdir}"/opt/s6/service/getty-tty1/run
#  install -Dm755 "${srcdir}"/opt-s6-service-udev-run       "${pkgdir}"/opt/s6/service/udev/run

  # license

  install -Dm644 "${srcdir}"/LICENSE "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE
}
