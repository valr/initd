# Maintainer: valr <valere dot monseur at ymail dot com>

pkgname=initsystem
pkgver=1.0.0
pkgrel=1
pkgdesc='an init system'
url='https://github.com/valr/initsystem'
license=('GPL')
groups=('initsystem')
arch=('x86_64')
depends=('busybox' 'kbd')
makedepends=('musl-cross-compiler-x86_64' 'musl')
optdepends=('eudev: replaces udev from systemd')
backup=('etc/rc.conf' 'etc/rc.local' 'etc/rc.shutdown.local')
install='initsystem.install'
source=('init.c'
        'rc'
        'rc.conf'
        'rc.local'
        'rc.respawn'
        'rc.shutdown'
        'rc.shutdown.local'
        'shutdown'
        'tmpfiles'
        'rc.subr'
        'rc.d.acpi'
        'rc.d.alsa'
        'rc.d.bumblebee'
        'rc.d.cron'
        'rc.d.cups'
        'rc.d.dbus'
        'rc.d.dhcpcd'
        'rc.d.eudev'
        'rc.d.iptables'
        'rc.d.ip6tables'
        'rc.d.syslog'
        'rc.d.tlp'
        'rc.d.udev'
        'rc.d.wireless'
        'LICENSE')
md5sums=('d20ccb0b26510b77f0ebf9c48f6fab0f'
         '54be417577fd46edb4fcfeee206c6edc'
         '3f62202d7becacc7022e50bbaff83388'
         'f9d345202573c58dfea5f7d39530b36d'
         '0016d7bd9a0a85316796387789c03ba4'
         'e1df3be4eed6263e3d046cd5f52106a2'
         '8c53ae0e2e5584999f47f905bc226e5f'
         '07c56d75dd64e0a04a3cccf28f5d7e97'
         '9d0cce73f5c7e7dd3f1cc8bf33de9f88'
         'ebb2b2bb22c08fa6a0411b6fec1d9eae'
         'b3158a98409ad0234d874f257aef7d30'
         '6fd3ad2827b1e7ac09bfe8bfc0d6fa40'
         '35d1e017de6158617f2b1a2bbf291044'
         'c81ad8cc66bd819b75c354234959384a'
         'fba02ce5db7274182bbef5ce16aa79f2'
         '9bc2327de5108e2654f568b5e1eacd63'
         'ed5afbda540156cc7d279133716248fe'
         'c2f4e490b32daf4f1bd182761abf08a9'
         'eb26a94b6798b9cf59003dd055b3e259'
         'f855f47cbb78ddba6fdb779e596a64ea'
         'e1e0e1d9ac88b02698c117833164e1b8'
         'a5dbd75bafd5a575e7fbe72e1220b608'
         '638efa85c102f58d4056443c65f9ede7'
         '1a6eee4c7bba9ee52607547dc1532b68'
         '4641e94ec96f98fabc56ff9cc48be14b')

build() {
  cd "${srcdir}"

  /opt/x86_64-linux-musl/bin/x86_64-linux-musl-gcc -Wall -static -o init init.c
}

package() {

  # configuration

  install -Dm644 "${srcdir}"/rc.conf "${pkgdir}"/etc/rc.conf

  # binaries

  install -Dm755 "${srcdir}"/init              "${pkgdir}"/usr/bin/init
  install -Dm755 "${srcdir}"/rc                "${pkgdir}"/etc/rc
  install -Dm755 "${srcdir}"/rc.local          "${pkgdir}"/etc/rc.local
  install -Dm755 "${srcdir}"/rc.respawn        "${pkgdir}"/etc/rc.respawn
  install -Dm755 "${srcdir}"/rc.shutdown       "${pkgdir}"/etc/rc.shutdown
  install -Dm755 "${srcdir}"/rc.shutdown.local "${pkgdir}"/etc/rc.shutdown.local
  install -Dm755 "${srcdir}"/shutdown          "${pkgdir}"/usr/bin/shutdown
  install -Dm755 "${srcdir}"/tmpfiles          "${pkgdir}"/usr/bin/tmpfiles

  # services

  install -Dm755 "${srcdir}"/rc.subr        "${pkgdir}"/etc/rc.subr
  install -Dm755 "${srcdir}"/rc.d.acpi      "${pkgdir}"/etc/rc.d/acpi
  install -Dm755 "${srcdir}"/rc.d.alsa      "${pkgdir}"/etc/rc.d/alsa
  install -Dm755 "${srcdir}"/rc.d.bumblebee "${pkgdir}"/etc/rc.d/bumblebee
  install -Dm755 "${srcdir}"/rc.d.cron      "${pkgdir}"/etc/rc.d/cron
  install -Dm755 "${srcdir}"/rc.d.cups      "${pkgdir}"/etc/rc.d/cups
  install -Dm755 "${srcdir}"/rc.d.dbus      "${pkgdir}"/etc/rc.d/dbus
  install -Dm755 "${srcdir}"/rc.d.dhcpcd    "${pkgdir}"/etc/rc.d/dhcpcd
  install -Dm755 "${srcdir}"/rc.d.eudev     "${pkgdir}"/etc/rc.d/eudev
  install -Dm755 "${srcdir}"/rc.d.iptables  "${pkgdir}"/etc/rc.d/iptables
  install -Dm755 "${srcdir}"/rc.d.ip6tables "${pkgdir}"/etc/rc.d/ip6tables
  install -Dm755 "${srcdir}"/rc.d.tlp       "${pkgdir}"/etc/rc.d/tlp
  install -Dm755 "${srcdir}"/rc.d.syslog    "${pkgdir}"/etc/rc.d/syslog
  install -Dm755 "${srcdir}"/rc.d.udev      "${pkgdir}"/etc/rc.d/udev
  install -Dm755 "${srcdir}"/rc.d.wireless  "${pkgdir}"/etc/rc.d/wireless

  # symlinks

  cd "${pkgdir}"/usr/bin

  ln -s shutdown halt
  ln -s shutdown poweroff
  ln -s shutdown reboot

  # license

  install -Dm644 "${srcdir}"/LICENSE "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE
}
